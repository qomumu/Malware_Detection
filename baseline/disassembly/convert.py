import sys
import os
from random import *
import subprocess
 
global idcScriptFileName
global ida32tFilePath
global ida64tFilePath
 
# File these feilds with ur own ida file path and the idc file u want to execute!
 
idcScriptFileName = "plugin.idc"
ida32tFilePath = r".\IDA_Pro_v6.8\idaq"
ida64tFilePath = r".\IDA_Pro_v6.8\idaq64"

print('Read all files with TargetFiles!')

file_path='.\\TargetFiles'
os.remove('target_file_list.txt')
file_list=[i for i in os.listdir(file_path)]
fw=open('target_file_list.txt','a')
for file in file_list:
    fw.write('%s\\%s\n'%(file_path,file))
fw.close()

#the binary file list text
TargetList = "target_file_list.txt"
TargetFile_object = open(TargetList,"r").readlines()
for eachline in TargetFile_object:
    eachline = eachline.replace('\n','').replace('\r','')
    print(eachline)
    if os.path.exists(eachline):
        tmpExecStr = ida64tFilePath +" -A -c -S" + idcScriptFileName + " " + eachline
        print (tmpExecStr)
        os.system(tmpExecStr) 
        tmpExecStr = ida32tFilePath +" -A -c -S" + idcScriptFileName + " " + eachline
        print (tmpExecStr)
        os.system(tmpExecStr)

print ("All Process have been started!")

train_path='D:\\TrainData\\subtrain\\'
file_list=[i for i in os.listdir(file_path)]
for i in range(len(file_list)):
    if 'asm' in file_list[i]:
        print(file_list[i])
        asm_file_path = file_path + file_list[i]
        asm_train_path = train_path + file_list[i]
        os.rename(asm_file_path, asm_train_path)
        print(asm_file_path)

print ("Split dataset have been started!")

rs = Random()

for filename in os.listdir(r'D:\TrainData\subtrain'):
    string_gen = rs.sample(['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','z','y','x','w','v','u','t','s','r','q','p','o','n','m','l','k','j','i','h','g','f','e','d','c','b','a'], 20)
    file_name = ''.join(string_gen) + '.asm'
    filepath = os.path.join(r'D:\TrainData\subtrain',filename)
    newpath = os.path.join(r'D:\TrainData\subtrain',file_name)
    os.rename(filepath,newpath)

l=[]

for filename in os.listdir(r'D:\TrainData\subtrain'):
    file_name = os.path.splitext(filename)[0]
    l.append(file_name)

f=open("dataset.csv","w")
for line in l:
    f.write(line+'\n')
f.close()

print ("Normalize have been started!")