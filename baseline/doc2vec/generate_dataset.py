import os
import shutil
import pandas as pd
import torch.utils.data

from vectorize_asm import *


class MalwareData(torch.utils.data.Dataset):
    def __init__(self, x, y):
        self.x = np.asarray(x)
        self.y = np.asarray(y)

    def __getitem__(self, item):
        x = self.x[item]
        y = self.y[item]

        x = torch.from_numpy(x)

        return x.float(), y

    def __len__(self):
        return len(self.x)


def split_dataset(src_path, dest_path, label_path):
    """
    Split all .asm files into 9 categories, each category representing a family.
    :param src_path: The path of all .asm files.
    :param dest_path: The path of 9 categories.
    :param label_path: The path of labels.csv.
    """
    # Read labels.csv
    df = pd.read_csv(label_path)

    if not os.path.exists(dest_path):
        os.mkdir(dest_path)
    # Split dataset into 9 categories
    for i in range(0, 1):

        filename_list = df.Id[df['Class'] == i].tolist()
        # Delete the same file names
        filename_list = list(set(filename_list))
        if not os.path.exists(dest_path + str(i)):
            os.mkdir(dest_path + str(i))
        for file_name in filename_list:
            shutil.move(src_path + file_name + '.asm', dest_path + str(i) + '/' + file_name + '.asm')

    # os.rmdir(src_path)


def generate_train_test(path):
    """
    Split all .asm.vec files into training samples and test samples.
    :param path: The path of all .asm.vec files.
    """
    train_path = '/'.join(path.split('/')[:-1]) + "/train/"
    test_path = '/'.join(path.split('/')[:-1]) + "/test/"

    dirs = os.listdir(path)
    for dir in dirs:
        files = os.listdir(path + dir)

        num = len(files)
        train_num = int(num * 0.8)

        if not os.path.exists(train_path):
            os.mkdir(train_path)
        if not os.path.exists(test_path):
            os.mkdir(test_path)
        if not os.path.exists(train_path + dir):
            os.mkdir(train_path + dir)
        if not os.path.exists(test_path + dir):
            os.mkdir(test_path + dir)

        for vec in files[0:train_num]:
            shutil.move(path + dir + '/' + vec, train_path + dir + '/' + vec)
        for vec in files[train_num:]:
            shutil.move(path + dir + '/' + vec, test_path + dir + '/' + vec)

        os.rmdir(path + dir)


def get_dataset(path):
    """
    Get dataset from training path or test path.
    :param path: The path of .asm.vec files.
    :return: Training dataset or test dataset.
    """
    x = []
    y = []
    dirs = os.listdir(path)
    for dir in dirs:
        for vec in os.listdir(path + dir):
            x.append(np.loadtxt(path + dir + '/' + vec))
            y.append(int(dir) - 1)

    return MalwareData(x, y)


if __name__ == "__main__":
    # split_dataset('D:/TrainData/subtrain/', 'D:/TrainData/subtrain/data/', 'D:/TrainData/subtrainLabels.csv')
    # Generate the Doc2Vec model
    asm_path = 'D:/TrainData/subtrain_v2/data/'
    doc2vec_model_path = 'D:/TrainData/subtrain_v2/doc2vec.model'
    vec_path = 'D:/TrainData/malware_subset_v2/vec/'
    my_doc2vec(asm_path, doc2vec_model_path)
    vectorize_asm('D:/TrainData/subtrain_v2/data/', 'D:/TrainData/malware_subset_v2/vec/', doc2vec_model_path)
    generate_train_test(vec_path)
    # dataset = get_dataset('D:/TrainData/malware_subset_v2/vec/train/')
    # print(dataset)
